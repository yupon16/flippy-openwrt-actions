name: Build OpenWrt zcube1-max A-Route

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Select kernel version"
        required: true
        default: "6.12.y"
        type: choice
        options:
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y
          - 6.1.y_6.12.y

env:
  TZ: Etc/UTC
  PACKAGED_OUTPUTPATH: /opt/openwrt_packit/output

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:

    # -------------------------
    # 1. Checkout repo
    # -------------------------
    - name: Checkout repository
      uses: actions/checkout@v6

    # -------------------------
    # 2. Initialize environment
    # -------------------------
    - name: Initialization environment
      shell: bash
      run: |
        sudo swapoff -a || true
        sudo apt-get update
        sudo apt-get -y install $(curl -fsSL https://ophub.org/ubuntu2404-make-openwrt-depends)
        sudo apt-get -y autoremove --purge
        sudo apt-get clean
        sudo timedatectl set-timezone "${TZ}"
        date

    # -------------------------
    # 3. Download zcube1-max rootfs
    # -------------------------
    - name: Download OpenWrt ARMv8 rootfs
      shell: bash
      run: |
        set -e
        mkdir -p opt/download

        json=$(curl -fsSL https://api.github.com/repos/ophub/flippy-openwrt-actions/releases)

        url=$(echo "$json" | jq -r '
          [.[] | select(.tag_name | contains("OpenWrt_armv8_rootfs"))][0]
          .assets[] | select(.name | contains("zcube1-max") and endswith("-rootfs.tar.gz")) | .browser_download_url
        ')

        name=$(basename "$url")

        if [ -z "$url" ]; then
          echo "[FATAL] Cannot locate zcube1-max rootfs asset"
          exit 1
        fi

        echo "[INFO] Downloading $name"
        curl -L "$url" -o "opt/download/$name"

        echo "OPENWRT_ARMSR=$PWD/opt/download/$name" >> $GITHUB_ENV

    # -------------------------
    # 4. Build OpenWrt image
    # -------------------------
    - name: Build OpenWrt image (flippy)
      uses: ophub/flippy-openwrt-actions@main
      env:
        OPENWRT_ARMSR: ${{ env.OPENWRT_ARMSR }}
        PACKAGE_SOC: zcube1-max
        KERNEL_REPO_URL: breakingbadboy/OpenWrt
        KERNEL_VERSION_NAME: ${{ github.event.inputs.openwrt_kernel }}
        KERNEL_AUTO_LATEST: true
        OPENWRT_IP: 192.168.1.1
        CUSTOMIZE_RK3399: sw799:rk3399-bozz-sw799.dtb
        SCRIPT_DIY_PATH: ""
        WHOAMI: ophub

    # -------------------------
    # 5. Patch A-Route DTB
    # -------------------------
    - name: Patch A-Route DTB
      shell: bash
      run: |
        set -e
        IMG=$(ls ${PACKAGED_OUTPUTPATH}/openwrt_*zcube1-max*.img.gz | head -n1)
        if [ -z "$IMG" ]; then
          echo "[FATAL] zcube1-max image not found"
          exit 1
        fi

        echo "[INFO] Unpacking $IMG"
        gzip -dc "$IMG" > openwrt.img

        sudo losetup -Pf openwrt.img
        LOOP=$(losetup -a | grep openwrt.img | cut -d: -f1)

        sudo mkdir -p /mnt/openwrt
        sudo mount ${LOOP}p1 /mnt/openwrt || sudo mount ${LOOP}p2 /mnt/openwrt

        echo "[INFO] Verify DTB existence"
        test -f /mnt/openwrt/dtb/rockchip/rk3399-bozz-sw799.dtb

        echo "[INFO] Patch armbianEnv.txt if exists"
        if [ -f /mnt/openwrt/armbianEnv.txt ]; then
          sudo sed -i 's/^fdtfile=.*/fdtfile=rk3399-bozz-sw799.dtb/' /mnt/openwrt/armbianEnv.txt
        fi

        echo "[INFO] Patch extlinux.conf if exists"
        if [ -f /mnt/openwrt/extlinux/extlinux.conf ]; then
          sudo sed -i 's|FDT .*|FDT /dtb/rockchip/rk3399-bozz-sw799.dtb|' /mnt/openwrt/extlinux/extlinux.conf
        fi

        sync
        sudo umount /mnt/openwrt
        sudo losetup -d $LOOP

        echo "[INFO] Repack A-Route image"
        gzip -9 openwrt.img
        mv openwrt.img.gz ${PACKAGED_OUTPUTPATH}/openwrt_zcube1-max_A-Route.img.gz
