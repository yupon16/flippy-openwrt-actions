name: Build OpenWrt RK3399 with Custom DTB

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Kernel version (e.g., 6.6.y)"
        required: false
        default: "6.6.y"
        type: string
      openwrt_ip:
        description: "Default LAN IP for OpenWrt"
        required: false
        default: "192.168.1.1"
        type: string
      builder_name:
        description: "Builder identifier"
        required: false
        default: "yupon16"
        type: string

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y u-boot-tools wget jq curl

      - name: Download OpenWrt rootfs (armsr)
        run: |
          mkdir -p /opt/download
          cd /opt/download
          latest=$(curl -s https://api.github.com/repos/ophub/flippy-openwrt-actions/releases | \
                   jq -r '.[] | select(.tag_name | startswith("OpenWrt_armv8_rootfs")) | .assets[0].browser_download_url' | head -1)
          if [ -z "$latest" ]; then
            echo "ERROR: Failed to find rootfs download URL"
            exit 1
          fi
          wget -O rootfs.tar.gz "$latest"

      - name: Prepare build directory
        run: |
          mkdir -p /opt/build
          cp /opt/download/rootfs.tar.gz /opt/build/

      - name: Download and extract flippy kernel (6.6.119)
        run: |
          mkdir -p /opt/kernel
          wget -O /opt/kernel.tar.gz https://github.com/ophub/kernel/releases/download/kernel_flippy/6.6.119.tar.gz
          tar -xzf /opt/kernel.tar.gz -C /opt/kernel
          # Log structure for debugging
          echo "Kernel archive contents:"
          find /opt/kernel -type f | sort

      - name: Locate and copy Image.gz
        run: |
          IMAGE_GZ=$(find /opt/kernel -name "Image.gz" | head -1)
          if [ -z "$IMAGE_GZ" ]; then
            echo "❌ ERROR: Image.gz not found in extracted kernel!"
            exit 1
          fi
          echo "✅ Found Image.gz: $IMAGE_GZ"
          cp "$IMAGE_GZ" /opt/build/

      - name: Use custom DTB from files/boot/dtb
        id: dtb
        run: |
          if [ ! -d "files/boot/dtb" ]; then
            echo "ERROR: Directory files/boot/dtb not found!"
            exit 1
          fi
          dtb_files=(files/boot/dtb/*.dtb)
          if [ ! -f "${dtb_files[0]}" ]; then
            echo "ERROR: No .dtb file found in files/boot/dtb/"
            exit 1
          fi
          CUSTOM_DTB="${dtb_files[0]}"
          echo "Using DTB: $CUSTOM_DTB"
          cp "$CUSTOM_DTB" /opt/build/
          DTB_NAME=$(basename "$CUSTOM_DTB" .dtb)
          echo "dtb_name=$DTB_NAME" >> "$GITHUB_OUTPUT"

      - name: Create FIT image (Image.itb) with custom DTB
        working-directory: /opt/build
        env:
          DTB_NAME: ${{ steps.dtb.outputs.dtb_name }}
        run: |
          gunzip -c Image.gz > Image
          CUSTOM_DTB_FILE=$(ls *.dtb | head -1)

          # Generate kernel.its without HERE-document to avoid YAML parsing issues
          printf '%s\n' \
            '/dts-v1/;' \
            '' \
            '/ {' \
            '    description = "OpenWrt FIT with custom DTB";' \
            '    #address-cells = <1>;' \
            '' \
            '    images {' \
            '        kernel@1 {' \
            '            description = "Linux Kernel";' \
            '            data = /incbin/("Image");' \
            '            type = "kernel";' \
            '            arch = "arm64";' \
            '            os = "linux";' \
            '            compression = "none";' \
            '            load = <0x00200000>;' \
            '            entry = <0x00200000>;' \
            '        };' \
            '' \
            '        fdt@1 {' \
            '            description = "'"$DTB_NAME"'";' \
            '            data = /incbin/("'"$CUSTOM_DTB_FILE"'");' \
            '            type = "flat_dt";' \
            '            arch = "arm64";' \
            '            compression = "none";' \
            '        };' \
            '    };' \
            '' \
            '    configurations {' \
            '        default = "conf@1";' \
            '        conf@1 {' \
            '            description = "Boot with custom DTB";' \
            '            kernel = "kernel@1";' \
            '            fdt = "fdt@1";' \
            '        };' \
            '    };' \
            '};' > kernel.its

          mkimage -f kernel.its Image.itb
          mkdir -p output
          cp Image.itb output/
          cp rootfs.tar.gz output/
          cp "$CUSTOM_DTB_FILE" output/
          cd output
          sha256sum * > sha256sums
          ls -lh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-rk3399-custom-dtb-${{ github.run_number }}
          path: /opt/build/output/

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: OpenWrt_rk3399_custom-dtb_$(date +%Y.%m.%d)
          artifacts: "/opt/build/output/*"
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            OpenWrt for RK3399 with custom DTB from `files/boot/dtb/`.
            - Kernel: flippy 6.6.119
            - Rootfs: armsr generic
            - No U-Boot included — use your original Android firmware bootloader.
            - Built by: ${{ inputs.builder_name }}
            - Default IP: ${{ inputs.openwrt_ip }}
