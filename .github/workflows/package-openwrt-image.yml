#==========================================================================
# Description: Package OpenWrt image (rk3399-sw799 only)
#==========================================================================
name: Package OpenWrt image (rk3399-sw799)

on:
  workflow_dispatch:

env:
  TZ: Etc/UTC
  TARGET_SOC: rk3399
  TARGET_BOARD: sw799
  TARGET_DTB: rk3399-bozz-sw799.dtb
  DTB_SOURCE_PATH: files/boot/dtb/rk3399-bozz-sw799.dtb

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -e
          docker rmi -f $(docker images -q) 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android || true
          sudo swapoff -a || true
          sudo apt-get update
          sudo apt-get install -y $(curl -fsSL https://ophub.org/ubuntu2404-make-openwrt-depends)
          sudo timedatectl set-timezone "${TZ}"
          date

      - name: Create build disk
        run: |
          set -e
          sudo truncate -s 80G /builder.img
          sudo losetup /dev/loop8 /builder.img
          sudo mkfs.ext4 /dev/loop8
          sudo mkdir -p /builder
          sudo mount /dev/loop8 /builder
          sudo chown -R runner:runner /builder
          df -h

      - name: Download OpenWrt rootfs
        working-directory: /builder
        run: |
          set -e

          mkdir -p opt/download
          ln -sf /builder/opt $GITHUB_WORKSPACE/opt
          sudo ln -sf /builder/opt /opt

          echo "Downloading OpenWrt armv8 rootfs..."

          release_json=$(curl -fsSL https://api.github.com/repos/ophub/flippy-openwrt-actions/releases)

          rootfs_url=$(echo "$release_json" | jq -r '
            [.[] | select(.tag_name | contains("OpenWrt_armv8_rootfs"))]
            | sort_by(.published_at)
            | reverse
            | .[0].assets[]
            | select(.name | endswith("-rootfs.tar.gz"))
            | .browser_download_url
          ')

          rootfs_name=$(basename "$rootfs_url")

          echo "Rootfs URL: $rootfs_url"
          echo "Rootfs Name: $rootfs_name"

          curl -fL "$rootfs_url" -o "opt/download/$rootfs_name"

          ls -lh opt/download

      - name: Verify custom DTB exists
        run: |
          set -e
          echo "Checking DTB file..."
          ls -lh ${DTB_SOURCE_PATH}
          sha256sum ${DTB_SOURCE_PATH}

      - name: Package OpenWrt Firmware (rk3399-sw799 only)
        uses: ophub/flippy-openwrt-actions@main
        env:
          OPENWRT_ARMSR: opt/download/*rootfs.tar.gz
          PACKAGE_SOC: rk3399
          CUSTOMIZE_RK3399: sw799:${{ env.TARGET_DTB }}
          KERNEL_VERSION_NAME: 6.1.y_6.6.y
          KERNEL_AUTO_LATEST: true
          OPENWRT_IP: 192.168.1.1
          WHOAMI: sw799-builder

      - name: Enforce DTB & remove others
        run: |
          set -e
          OUT="${PACKAGED_OUTPUTPATH}"
          echo "Output path: $OUT"
          ls -R $OUT

          IMG=$(ls $OUT/*.img 2>/dev/null | head -n1)
          [ -z "$IMG" ] && echo "Image not found" && exit 1

          mkdir -p /tmp/img
          sudo mount -o loop,offset=1048576 "$IMG" /tmp/img || true

          echo "Removing all other rk3399 dtb..."
          find /tmp/img/boot/dtb -type f ! -name "${TARGET_DTB}" -delete

          echo "Remaining DTB:"
          ls -lh /tmp/img/boot/dtb

          echo "Force extlinux.conf to use ${TARGET_DTB}"
          sed -i "s/^ *FDT .*/  FDT \/boot\/dtb\/${TARGET_DTB}/" /tmp/img/boot/extlinux/extlinux.conf
          grep FDT /tmp/img/boot/extlinux/extlinux.conf

          sudo umount /tmp/img

      - name: Verify DTB usage in image (log)
        run: |
          set -e
          echo "Verifying DTB reference..."
          strings ${PACKAGED_OUTPUTPATH}/*.img | grep rk3399-bozz-sw799.dtb
          echo "DTB verification PASSED"

      - name: Upload OpenWrt Firmware to Release
        if: ${{ env.PACKAGED_STATUS }} == 'success'
        uses: ncipollo/release-action@main
        with:
          tag: rk3399-sw799-${{ github.run_number }}
          artifacts: ${{ env.PACKAGED_OUTPUTPATH }}/*
          allowUpdates: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### OpenWrt rk3399-sw799
            - DTB: rk3399-bozz-sw799.dtb (forced)
            - Only this DTB is included and loaded by U-Boot
            - Default IP: 192.168.1.1
            - User: root / password
