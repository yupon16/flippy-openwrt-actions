name: Build OpenWrt SW799 (A-Route)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build OpenWrt image (flippy pack)
        uses: ophub/flippy-openwrt-actions@main

      - name: A-Route patch image safely
        shell: bash
        env:
          PACKAGED_OUTPUTPATH: /opt/openwrt_packit/output
        run: |
          set -euo pipefail

          echo "[INFO] Locate firmware image"
          IMG=$(ls ${PACKAGED_OUTPUTPATH}/openwrt_*zcube1-max*.img.gz | head -n 1 || true)

          if [ -z "${IMG:-}" ]; then
            echo "[WARN] zcube1-max image not found, skip A-Route"
            exit 0
          fi

          echo "[INFO] Unpacking $IMG"
          gzip -dc "$IMG" > openwrt.img

          cleanup() {
            set +e
            mountpoint -q /mnt/openwrt && sudo umount /mnt/openwrt
            [ -n "${LOOPDEV:-}" ] && sudo losetup -d "$LOOPDEV"
          }
          trap cleanup EXIT

          echo "[INFO] Setup loop device"
          LOOPDEV=$(sudo losetup --show -Pf openwrt.img)
          echo "[INFO] Loop device: $LOOPDEV"

          sudo mkdir -p /mnt/openwrt

          echo "[INFO] Detect partition to mount"
          for p in ${LOOPDEV}p*; do
            if sudo mount "$p" /mnt/openwrt 2>/dev/null; then
              echo "[INFO] Mounted $p"
              break
            fi
          done

          if ! mountpoint -q /mnt/openwrt; then
            echo "[WARN] No mountable partition found, skip patch"
            exit 0
          fi

          echo "[INFO] Search DTB"
          DTB=$(find /mnt/openwrt -name 'rk3399-bozz-sw799*.dtb' | head -n 1 || true)

          if [ -z "${DTB:-}" ]; then
            echo "[WARN] DTB not found in image, skip DTB patch"
          else
            echo "[INFO] Found DTB: $DTB"

            if [ -f /mnt/openwrt/armbianEnv.txt ]; then
              echo "[INFO] Patch armbianEnv.txt"
              sudo sed -i \
                "s|^fdtfile=.*|fdtfile=$(basename "$DTB")|" \
                /mnt/openwrt/armbianEnv.txt
            fi

            if [ -f /mnt/openwrt/extlinux/extlinux.conf ]; then
              echo "[INFO] Patch extlinux.conf"
              sudo sed -i \
                "s|^ *FDT .*|  FDT ${DTB#/mnt/openwrt}|" \
                /mnt/openwrt/extlinux/extlinux.conf
            fi
          fi

          sync
          echo "[INFO] Repack image"
          gzip -9 openwrt.img
          mv openwrt.img.gz \
            ${PACKAGED_OUTPUTPATH}/openwrt_zcube1-max_A-Route.img.gz

          echo "[INFO] A-Route completed successfully"
