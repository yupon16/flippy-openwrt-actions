name: Build OpenWrt image (SW799 DIY)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download OpenWrt rootfs
        run: |
          set -e
          mkdir -p opt/download

          ROOTFS_REPO="ophub/flippy-openwrt-actions"
          ROOTFS_TAG="OpenWrt_armv8_rootfs"
          ROOTFS_SUFFIX="-rootfs.tar.gz"

          release_json=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${ROOTFS_REPO}/releases?per_page=20")

          asset_info=$(echo "${release_json}" | jq -r \
            --arg TAG "${ROOTFS_TAG}" \
            --arg SUF "${ROOTFS_SUFFIX}" \
            '[.[] | select(.tag_name | contains($TAG))] |
             map(.assets[] | select(.name | endswith($SUF))) |
             sort_by(.updated_at) |
             reverse |
             .[0]')

          asset_url=$(echo "${asset_info}" | jq -r '.url')
          asset_name=$(echo "${asset_info}" | jq -r '.name')

          echo "Downloading ${asset_name}"

          curl -fSL \
            -H "Accept: application/octet-stream" \
            "${asset_url}" \
            -o "opt/download/${asset_name}"

          ls -lh opt/download

      - name: Build OpenWrt DIY image
        uses: ophub/flippy-openwrt-actions@main
        with:
          mode: flippy
        env:
          PACKAGE_SOC: diy
          SCRIPT_DIY: mk_sw799.sh
          SCRIPT_DIY_PATH: diy/sw799/mk_sw799.sh

          # ⭐⭐⭐ 核心：必须存在，且只写文件名 ⭐⭐⭐
          OPENWRT_ARMSR: openwrt-armsr-armv8-generic-rootfs.tar.gz

          KERNEL_VER: 6.6.68
          ENABLE_WIFI: false
          UPLOAD_RELEASE: true
