name: OpenWrt zcube1-max A-Route

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Kernel version"
        required: true
        default: "6.12.y"
        type: choice
        options:
          - 6.1.y
          - 6.6.y
          - 6.12.y

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download OpenWrt armsr-armv8 rootfs
      run: |
        set -e
        mkdir -p opt/download

        json=$(curl -fsSL https://api.github.com/repos/ophub/flippy-openwrt-actions/releases)

        asset=$(echo "$json" | jq -r '
          [.[] 
            | select(.tag_name | contains("OpenWrt_armv8_rootfs"))
            | .assets[]
            | select(.name | contains("armsr-armv8") and endswith("-rootfs.tar.gz"))
          ][0]
        ')

        url=$(echo "$asset" | jq -r '.url')
        name=$(echo "$asset" | jq -r '.name')

        if [ -z "$url" ] || [ "$url" = "null" ]; then
          echo "[FATAL] armsr-armv8 rootfs not found"
          exit 1
        fi

        echo "Downloading $name"
        curl -L \
          -H "Accept: application/octet-stream" \
          "$url" \
          -o "opt/download/$name"

        echo "OPENWRT_ARMSR=opt/download/$name" >> $GITHUB_ENV


    # 2. 使用 flippy 正常打 zcube1-max 包
    - name: Build OpenWrt zcube1-max
      uses: ophub/flippy-openwrt-actions@main
      env:
        OPENWRT_ARMSR: ${{ env.OPENWRT_ARMSR }}
        PACKAGE_SOC: zcube1-max
        KERNEL_VERSION_NAME: ${{ inputs.openwrt_kernel }}

    # 3. 解包并执行 A Route 补丁
    - name: Patch fdtfile (A Route)
      if: ${{ env.PACKAGED_STATUS }} == 'success'
      run: |
        set -e

        echo "[INFO] Locate firmware image"
        IMG=$(ls ${PACKAGED_OUTPUTPATH}/openwrt_*zcube1-max*.img.gz | head -n 1)

        if [ -z "$IMG" ]; then
          echo "[FATAL] zcube1-max image not found"
          exit 1
        fi

        echo "[INFO] Unpacking $IMG"
        gzip -dc "$IMG" > openwrt.img

        sudo losetup -Pf openwrt.img
        LOOP=$(losetup -a | grep openwrt.img | cut -d: -f1)

        sudo mkdir -p /mnt/openwrt
        sudo mount ${LOOP}p1 /mnt/openwrt || sudo mount ${LOOP}p2 /mnt/openwrt

        echo "[INFO] Verify DTB existence"
        test -f /mnt/openwrt/dtb/rockchip/rk3399-bozz-sw799.dtb

        echo "[INFO] Patch armbianEnv.txt if exists"
        if [ -f /mnt/openwrt/armbianEnv.txt ]; then
          sudo sed -i 's/^fdtfile=.*/fdtfile=rk3399-bozz-sw799.dtb/' /mnt/openwrt/armbianEnv.txt
        fi

        echo "[INFO] Patch extlinux.conf if exists"
        if [ -f /mnt/openwrt/extlinux/extlinux.conf ]; then
          sudo sed -i 's|FDT .*|FDT /dtb/rockchip/rk3399-bozz-sw799.dtb|' /mnt/openwrt/extlinux/extlinux.conf
        fi

        sync
        sudo umount /mnt/openwrt
        sudo losetup -d $LOOP

        echo "[INFO] Repack A-Route image"
        gzip -9 openwrt.img
        mv openwrt.img.gz \
           ${PACKAGED_OUTPUTPATH}/openwrt_zcube1-max_A-Route.img.gz


    # 4. 发布
    - name: Upload A-Route firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-zcube1-max-A-Route
        path: openwrt_zcube1-max_A-Route.img.gz
