name: Package OpenWrt image (rk3399-sw799)

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Kernel version"
        required: false
        default: "6.1.y_6.6.y"
        type: choice
        options:
          - 6.1.y
          - 6.6.y
          - 6.1.y_6.6.y
      auto_kernel:
        description: "Auto use latest kernel"
        required: false
        default: true
        type: boolean

env:
  TZ: Etc/UTC
  TARGET_SOC: rk3399
  TARGET_BOARD: sw799
  TARGET_DTB: rk3399-bozz-sw799.dtb
  DTB_SOURCE_PATH: files/boot/dtb/rk3399-bozz-sw799.dtb

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Init build env
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y $(curl -fsSL https://ophub.org/ubuntu2404-make-openwrt-depends)
          sudo timedatectl set-timezone "$TZ"

      - name: Prepare workspace
        run: |
          sudo truncate -s 80G /builder.img
          sudo losetup /dev/loop8 /builder.img
          sudo mkfs.ext4 /dev/loop8
          sudo mkdir -p /builder
          sudo mount /dev/loop8 /builder
          sudo chown -R runner:runner /builder

      - name: Download OpenWrt rootfs
        working-directory: /builder
        run: |
          set -e

          mkdir -p opt/download
          ln -sf /builder/opt $GITHUB_WORKSPACE/opt
          sudo ln -sf /builder/opt /opt

          release_json=$(curl -fsSL https://api.github.com/repos/ophub/flippy-openwrt-actions/releases)

          rootfs_url=$(echo "$release_json" | jq -r '
            [.[] | select(.tag_name == "OpenWrt_armv8_rootfs")][0].assets
            | map(select(.name | test("armsr.*-rootfs.tar.gz$")))
            | sort_by(.updated_at)
            | reverse
            | .[0].browser_download_url
          ')

          [ -z "$rootfs_url" ] && exit 1

          rootfs_name=$(basename "$rootfs_url")

          echo "Downloading: $rootfs_name"
          curl -fL "$rootfs_url" -o "opt/download/$rootfs_name"

          ls -lh opt/download

      - name: Verify DTB
        run: |
          set -e
          ls -lh $DTB_SOURCE_PATH
          sha256sum $DTB_SOURCE_PATH

      - name: Package OpenWrt (rk3399-sw799)
        uses: ophub/flippy-openwrt-actions@main
        env:
          OPENWRT_ARMSR: opt/download/*rootfs.tar.gz
          PACKAGE_SOC: rk3399
          CUSTOMIZE_RK3399: sw799:rk3399-bozz-sw799.dtb
          KERNEL_VERSION_NAME: ${{ inputs.openwrt_kernel }}
          KERNEL_AUTO_LATEST: ${{ inputs.auto_kernel }}
          OPENWRT_IP: 192.168.1.1
          WHOAMI: sw799

      - name: Upload firmware
        if: ${{ env.PACKAGED_STATUS }} == 'success'
        uses: ncipollo/release-action@main
        with:
          tag: rk3399-sw799-${{ github.run_number }}
          artifacts: ${{ env.PACKAGED_OUTPUTPATH }}/*
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fix rk3399 DTB placement (U-Boot required)
        run: |
          set -e

          OUT="${PACKAGED_OUTPUTPATH}"
          IMG=$(ls $OUT/*.img | head -n1)

          echo "Using image: $IMG"

          mkdir -p /tmp/img
          sudo mount -o loop,offset=1048576 "$IMG" /tmp/img

          echo "Ensure /dtb exists"
          sudo mkdir -p /tmp/img/dtb

          echo "Install correct DTB"
          sudo cp files/boot/dtb/rk3399-bozz-sw799.dtb /tmp/img/dtb/

          echo "Remove all other rk3399 dtb"
          sudo find /tmp/img/dtb -type f ! -name rk3399-bozz-sw799.dtb -delete

          echo "Verify DTB magic:"
          hexdump -C /tmp/img/dtb/rk3399-bozz-sw799.dtb | head -n 2

          sudo umount /tmp/img

