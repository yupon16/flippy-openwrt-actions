#==========================================================================
# Description: Build OpenWrt for zcube1-max (A 路线, DTB=rk3399-bozz-sw799)
#==========================================================================

name: Build OpenWrt zcube1-max (A Route)

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Select kernel version"
        required: true
        default: "6.1.y_6.12.y"
        type: choice
        options:
          - 6.1.y
          - 6.12.y
          - 6.1.y_6.12.y

env:
  TZ: Etc/UTC

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # ------------------------------------------------------------
      # 1. 初始化环境
      # ------------------------------------------------------------
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo swapoff -a || true
          sudo apt-get update
          sudo apt-get -y install $(curl -fsSL https://ophub.org/ubuntu2404-make-openwrt-depends)
          sudo apt-get -y autoremove --purge
          sudo apt-get clean
          sudo timedatectl set-timezone "${TZ}"
          date

      # ------------------------------------------------------------
      # 2. 下载 zcube1-max 原始 rootfs
      # ------------------------------------------------------------
      - name: Download OpenWrt rootfs
        run: |
          mkdir -p opt/download

          latest_json=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/ophub/flippy-openwrt-actions/releases?per_page=20)

          rootfs_url=$(echo "$latest_json" | jq -r '
            [.[] | select(.tag_name | contains("OpenWrt_armv8_rootfs"))]
            | .[0].assets[]
            | select(.name | contains("armsr-armv8") and contains("zcube1-max") and endswith("-rootfs.tar.gz"))
            | .url
          ')

          rootfs_name=$(echo "$latest_json" | jq -r '
            [.[] | select(.tag_name | contains("OpenWrt_armv8_rootfs"))]
            | .[0].assets[]
            | select(.name | contains("armsr-armv8") and contains("zcube1-max") and endswith("-rootfs.tar.gz"))
            | .name
          ')

          if [ -z "$rootfs_url" ]; then
            echo "Failed to find zcube1-max armsr-armv8 rootfs asset"
            exit 1
          fi

          echo "Downloading $rootfs_name"
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/octet-stream" \
            "$rootfs_url" \
            -o "opt/download/$rootfs_name"

          echo "OPENWRT_ARMSR=opt/download/$rootfs_name" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 3. Package OpenWrt 镜像
      # ------------------------------------------------------------
      - name: Package OpenWrt Firmware
        uses: ophub/flippy-openwrt-actions@main
        env:
          OPENWRT_ARMSR: ${{ env.OPENWRT_ARMSR }}
          PACKAGE_SOC: zcube1-max
          KERNEL_REPO_URL: breakingbadboy/OpenWrt
          KERNEL_VERSION_NAME: ${{ inputs.openwrt_kernel }}
          KERNEL_AUTO_LATEST: true
          CUSTOMIZE_RK3399: zcube1-max:rk3399-bozz-sw799.dtb
          OPENWRT_IP: 192.168.1.1
          WHOAMI: zcube1-max

      # ------------------------------------------------------------
      # 4. 上传到 Release
      # ------------------------------------------------------------
      - name: Upload OpenWrt Firmware
        uses: ncipollo/release-action@v1
        if: ${{ env.PACKAGED_STATUS }} == 'success'
        with:
          tag: OpenWrt_zcube1-max_${{ inputs.openwrt_kernel }}_${{ github.run_number }}
          artifacts: ${{ env.PACKAGED_OUTPUTPATH }}/*
          allowUpdates: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### OpenWrt zcube1-max Firmware
            - SoC: rk3399
            - DTB: rk3399-bozz-sw799.dtb
            - Kernel: ${{ inputs.openwrt_kernel }}
            - Default IP: 192.168.1.1
            - User: root / password
