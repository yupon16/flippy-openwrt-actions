name: Build OpenWrt zcube1-max (A Route)

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Select kernel version"
        required: true
        default: "6.12.y"
        type: choice
        options:
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1. 使用 flippy 原生方式打 zcube1-max
    - name: Build OpenWrt (zcube1-max)
      uses: ophub/flippy-openwrt-actions@main
      env:
        PACKAGE_SOC: zcube1-max
        KERNEL_VERSION_NAME: ${{ inputs.openwrt_kernel }}

    # 2. 定位生成的固件
    - name: Locate firmware
      run: |
        set -e
        IMAGE=$(ls out/openwrt_*zcube1-max*.img.gz | head -n 1)
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV

    # 3. 解压镜像
    - name: Unpack firmware
      run: |
        mkdir work
        gzip -dc "$IMAGE" > work/openwrt.img

    # 4. 挂载 + 自动补丁（A Route 核心）
    - name: Patch fdtfile (A Route)
      run: |
        set -e

        sudo losetup -Pf work/openwrt.img
        LOOP=$(losetup -a | grep openwrt.img | cut -d: -f1)

        sudo mkdir -p /mnt/openwrt
        sudo mount ${LOOP}p1 /mnt/openwrt || sudo mount ${LOOP}p2 /mnt/openwrt

        echo "[INFO] Checking DTB existence..."
        if [ ! -f /mnt/openwrt/dtb/rockchip/rk3399-bozz-sw799.dtb ]; then
          echo "[FATAL] rk3399-bozz-sw799.dtb not found in image"
          exit 1
        fi

        echo "[INFO] Patching fdtfile..."

        # armbianEnv.txt
        if [ -f /mnt/openwrt/armbianEnv.txt ]; then
          sudo sed -i 's/^fdtfile=.*/fdtfile=rk3399-bozz-sw799.dtb/' /mnt/openwrt/armbianEnv.txt
          echo "[OK] armbianEnv.txt patched"
        fi

        # extlinux.conf
        if [ -f /mnt/openwrt/extlinux/extlinux.conf ]; then
          sudo sed -i 's|FDT .*|FDT /dtb/rockchip/rk3399-bozz-sw799.dtb|' /mnt/openwrt/extlinux/extlinux.conf
          echo "[OK] extlinux.conf patched"
        fi

        sync
        sudo umount /mnt/openwrt
        sudo losetup -d $LOOP

    # 5. 重新压缩并标注 A-Route
    - name: Repack firmware
      run: |
        gzip -9 work/openwrt.img
        mkdir -p final
        mv work/openwrt.img.gz \
           final/openwrt_zcube1-max_${{ inputs.openwrt_kernel }}_A-Route.img.gz

    # 6. 发布
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-zcube1-max-A-Route
        path: final/*.img.gz
