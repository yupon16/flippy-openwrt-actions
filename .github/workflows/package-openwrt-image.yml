      - name: Use your custom DTB from files/boot/dtb
        id: dtb
        run: |
          if [ -d "files/boot/dtb" ] && ls files/boot/dtb/*.dtb >/dev/null 2>&1; then
            CUSTOM_DTB=$(ls files/boot/dtb/*.dtb | head -1)
            echo "Found DTB: $CUSTOM_DTB"
            cp "$CUSTOM_DTB" /opt/build/
            DTB_NAME=$(basename "$CUSTOM_DTB" .dtb)
            echo "dtb_name=$DTB_NAME" >> $GITHUB_OUTPUT
          else
            echo "ERROR: No .dtb found in files/boot/dtb/"
            exit 1
          fi

      - name: Create FIT image (Image.itb) with custom DTB
        working-directory: /opt/build
        env:
          DTB_NAME: ${{ steps.dtb.outputs.dtb_name }}
        run: |
          gunzip -c Image.gz > Image
          CUSTOM_DTB_FILE=$(ls *.dtb | head -1)

          cat > kernel.its <<EOF
/dts-v1/;

/ {
    description = "OpenWrt FIT with custom DTB";
    #address-cells = <1>;

    images {
        kernel@1 {
            description = "Linux Kernel";
            data = /incbin/("Image");
            type = "kernel";
            arch = "arm64";
            os = "linux";
            compression = "none";
            load = <0x00200000>;
            entry = <0x00200000>;
        };

        fdt@1 {
            description = "$DTB_NAME";   # ← 这里用 shell 变量，不是 GitHub 表达式！
            data = /incbin/("$CUSTOM_DTB_FILE");
            type = "flat_dt";
            arch = "arm64";
            compression = "none";
        };
    };

    configurations {
        default = "conf@1";
        conf@1 {
            description = "Boot with custom DTB";
            kernel = "kernel@1";
            fdt = "fdt@1";
        };
    };
};
EOF

          mkimage -f kernel.its Image.itb

          mkdir -p output
          cp Image.itb output/
          cp rootfs.tar.gz output/
          cp "$CUSTOM_DTB_FILE" output/

          cd output
          sha256sum * > sha256sums
          ls -lh
